<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pink & Blue Scientific Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --baby-pink: #ffd1dc;
    --baby-blue: #cfeefb;
    --panel: rgba(255,255,255,0.95);
    --accent: #ff9bb3;
    --accent2: #9dd8ff;
    --btn:#ffffff;
    --muted:#65707a;
    --text:#111827;
    --radius:14px;
    --shadow: 0 12px 30px rgba(18, 38, 63, 0.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--baby-pink),var(--baby-blue));display:flex;align-items:center;justify-content:center;padding:18px;color:var(--text)}
  .app{width:960px;max-width:98vw;background:var(--panel);border-radius:20px;padding:16px;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 320px;gap:14px}
  .calc{padding:12px;border-radius:12px}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,0.12)}
  .title{font-size:16px;margin:0}
  .subtitle{font-size:12px;color:var(--muted)}
  .right-controls{display:flex;gap:8px;align-items:center}
  .deg-toggle{padding:8px 10px;border-radius:10px;border:none;background:var(--btn);cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.06)}
  .display{background:linear-gradient(180deg,#fff,#fbfcff);border-radius:12px;padding:12px;text-align:right;min-height:86px;display:flex;flex-direction:column;justify-content:center;box-shadow:inset 0 -2px 8px rgba(0,0,0,0.03);margin-bottom:12px}
  .prev{font-size:13px;color:var(--muted);opacity:0.95}
  .curr{font-size:28px;font-weight:600;word-wrap:break-word;color:var(--text);margin-top:6px}
  .keypad{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  button.key{padding:12px;border-radius:10px;border:none;background:var(--btn);font-size:15px;cursor:pointer;box-shadow:0 8px 18px rgba(10,20,40,0.06);transition:transform .06s ease;user-select:none}
  button.key:active{transform:translateY(3px)}
  button.op{background:linear-gradient(180deg,#ffffff,#f2f6ff)}
  button.accent{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:600}
  .span2{grid-column:span 2}
  .span3{grid-column:span 3}
  /* side */
  .side{padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);box-shadow:inset 0 -2px 8px rgba(0,0,0,0.02)}
  .mem-row{display:flex;gap:6px;margin-bottom:10px}
  .mem-btn{flex:1;padding:8px;border-radius:8px;background:#fafafa;border:1px solid #eee;cursor:pointer}
  .history{max-height:520px;overflow:auto}
  .hist-item{padding:8px;border-radius:8px;background:linear-gradient(180deg,#fbfbff,#fff);margin-bottom:8px;border:1px solid #f0f0f0;cursor:pointer}
  .hist-exp{font-size:13px;color:var(--muted)}
  .hist-res{font-weight:600;margin-top:6px}
  .footer{font-size:12px;color:var(--muted);margin-top:12px;text-align:center}
  @media(max-width:980px){.app{grid-template-columns:1fr;}.side{order:-1;margin-bottom:12px}}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Pink Blue Calculator">
  <div class="calc" aria-label="Calculator">
    <div class="top">
      <div class="brand">
        <div class="logo">♡</div>
        <div>
          <div class="title">TinyCalc</div>
          <div class="subtitle">baby pink • baby blue</div>
        </div>
      </div>
      <div class="right-controls">
        <button id="degToggle" class="deg-toggle" title="Toggle Degrees/Radians">Deg</button>
      </div>
    </div>

    <div class="display" id="display" aria-live="polite">
      <div class="prev" id="prev"></div>
      <div class="curr" id="curr">0</div>
    </div>

    <div class="keypad" id="keypad" aria-hidden="false">
      <!-- memory & clear -->
      <button class="key op" data-action="mc">MC</button>
      <button class="key op" data-action="mr">MR</button>
      <button class="key op" data-action="mplus">M+</button>
      <button class="key op" data-action="mminus">M-</button>
      <button class="key op" data-action="ac">AC</button>
      <button class="key op" data-action="del">DEL</button>

      <!-- scientific row -->
      <button class="key" data-insert="(">(</button>
      <button class="key" data-insert=")">)</button>
      <button class="key" data-action="fact">x!</button>
      <button class="key" data-action="perc">%</button>
      <button class="key" data-action="sqrt">√</button>
      <button class="key" data-action="inv">1/x</button>

      <!-- trig/log -->
      <button class="key" data-insert="sin(">sin</button>
      <button class="key" data-insert="cos(">cos</button>
      <button class="key" data-insert="tan(">tan</button>
      <button class="key" data-action="ln">ln</button>
      <button class="key" data-action="log">log</button>
      <button class="key" data-action="exp">eˣ</button>

      <!-- numbers row -->
      <button class="key" data-insert="7">7</button>
      <button class="key" data-insert="8">8</button>
      <button class="key" data-insert="9">9</button>
      <button class="key op" data-insert="/">÷</button>
      <button class="key op" data-action="pow2">x²</button>
      <button class="key op" data-action="pow3">x³</button>

      <button class="key" data-insert="4">4</button>
      <button class="key" data-insert="5">5</button>
      <button class="key" data-insert="6">6</button>
      <button class="key op" data-insert="*">×</button>
      <button class="key op" data-action="powxy">xʸ</button>
      <button class="key op" data-action="pi">π</button>

      <button class="key" data-insert="1">1</button>
      <button class="key" data-insert="2">2</button>
      <button class="key" data-insert="3">3</button>
      <button class="key op" data-insert="-">−</button>
      <button class="key op" data-action="e">e</button>
      <button class="key op" data-action="rand">rnd</button>

      <button class="key span2" data-insert="0">0</button>
      <button class="key" data-insert=".">.</button>
      <button class="key op" data-insert="+">+</button>
      <button class="key span2 accent" data-action="equals">=</button>
    </div>
  </div>

  <div class="side" aria-label="History and memory">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <div style="font-size:13px;color:var(--muted)">Memory</div>
        <div style="margin-top:6px;font-weight:600;color:var(--muted)" id="memLabel">M = 0</div>
      </div>
      <div>
        <div style="font-size:13px;color:var(--muted)">Precision</div>
        <div style="margin-top:6px">
          <select id="mode" style="padding:8px;border-radius:8px;border:1px solid #eee">
            <option value="high">High Precision</option>
            <option value="short">Short</option>
          </select>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:600">History</div>
      <button id="clearHist" class="mem-btn" style="padding:6px 8px;">Clear</button>
    </div>
    <div class="history" id="history"></div>
    <div class="footer">Tip: Use keyboard. Enter = equals, Backspace = DEL, Delete = AC.</div>
  </div>
</div>

<script>
/* Clean, corrected calculator script (single-file).
   Fixes: do NOT replace 'e' globally; safe token transforms; deg/rad correct;
   tiny numeric noise treated as zero (so cos(90) -> 0).
*/

(() => {
  const currEl = document.getElementById('curr');
  const prevEl = document.getElementById('prev');
  const keypad = document.getElementById('keypad');
  const historyEl = document.getElementById('history');
  const degToggle = document.getElementById('degToggle');
  const memLabel = document.getElementById('memLabel');
  const modeSel = document.getElementById('mode');

  let expr = '';       // visible expression string
  let mem = 0;         // memory register
  let deg = true;      // degrees mode default
  let hist = [];       // history list

  // helper functions exposed to eval scope via closure:
  const PI = Math.PI;
  const E = Math.E;
  function sin(x){ return deg ? Math.sin(x * Math.PI/180) : Math.sin(x); }
  function cos(x){ return deg ? Math.cos(x * Math.PI/180) : Math.cos(x); }
  function tan(x){ return deg ? Math.tan(x * Math.PI/180) : Math.tan(x); }
  function log(x){ return Math.log10 ? Math.log10(x) : Math.log(x)/Math.LN10; }
  function ln(x){ return Math.log(x); }
  function sqrt(x){ return Math.sqrt(x); }
  function exp(x){ return Math.exp(x); }
  function pow(a,b){ return Math.pow(a,b); }
  function fact(n){
    if(n < 0) return NaN;
    if(Math.abs(n - Math.round(n)) > 1e-12) return NaN;
    n = Math.round(n);
    if(n > 170) return Infinity;
    let r = 1;
    for(let i=2;i<=n;i++) r *= i;
    return r;
  }

  // format a number for display (short/high precision)
  function fmtValue(v){
    if(v === 'Error') return 'Error';
    if(!isFinite(v)) return 'Error';
    if(Math.abs(v) < 1e-12) return '0';
    if(modeSel.value === 'short'){
      return Number(v).toPrecision(10).replace(/\.?0+$/,'');
    } else {
      // high precision
      return Number(v).toPrecision(12).replace(/\.?0+$/,'');
    }
  }

  // update UI
  function updateDisplay(){
    currEl.textContent = expr || '0';
  }

  // safe transform: only operate on tokens, not inside function names
  function transformExpression(raw){
    let s = String(raw);

    // normalize characters
    s = s.replaceAll('−','-').replaceAll('×','*').replaceAll('÷','/');

    // replace pi symbol with identifier PI (we define PI in closure)
    s = s.replaceAll('π','PI');

    // replace caret ^ with JS exponent operator **
    s = s.replace(/\^/g, '**');

    // handle percent: convert "number%" or "(... )%" into (x/100)
    const percentRegex = /(\d+(\.\d+)?|\([^()]*\))%/;
    while(percentRegex.test(s)){
      s = s.replace(percentRegex, '($1/100)');
    }

    // handle factorial: convert postfix n! or (expr)! -> fact(n)
    const factRegex = /(\d+(\.\d+)?|\([^()]*\))!/;
    while(factRegex.test(s)){
      s = s.replace(factRegex, 'fact($1)');
    }

    // nothing else replaced — functions like sin, cos, log, ln, sqrt, exp are present in scope
    return s;
  }

  // evaluate expression safely within the closure scope
  function evaluateExpression(raw){
    if(!raw || raw.trim() === '') return 0;
    try {
      const jsExpr = transformExpression(raw);
      // eval will use the functions/symbols we declared in closure (sin, cos, PI, E, etc.)
      const result = eval(jsExpr);
      if(result === undefined) return 'Error';
      if(typeof result === 'number'){
        if(!isFinite(result)) return 'Error';
        if(Math.abs(result) < 1e-12) return 0;
        return Number(result);
      }
      return result;
    } catch(e){
      return 'Error';
    }
  }

  // history render
  function pushHistory(exp, res){
    hist.unshift({exp, res});
    if(hist.length > 200) hist.pop();
    renderHistory();
  }
  function renderHistory(){
    historyEl.innerHTML = '';
    for(const item of hist){
      const div = document.createElement('div');
      div.className = 'hist-item';
      div.innerHTML = `<div class="hist-exp">${escapeHtml(item.exp)}</div><div class="hist-res">${escapeHtml(fmtValue(item.res))}</div>`;
      div.addEventListener('click', ()=>{ expr = item.exp; updateDisplay(); });
      historyEl.appendChild(div);
    }
  }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

  // keypad click handling
  keypad.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    const ins = btn.dataset.insert;
    const action = btn.dataset.action;
    if(ins !== undefined){
      expr += ins;
      updateDisplay();
      return;
    }
    if(action) handleAction(action);
  });

  function handleAction(a){
    switch(a){
      case 'ac': expr = ''; updateDisplay(); break;
      case 'del': expr = expr.slice(0,-1); updateDisplay(); break;
      case 'perc': expr += '%'; updateDisplay(); break;
      case 'sqrt': expr += 'sqrt('; updateDisplay(); break;
      case 'pow2': expr += '^2'; updateDisplay(); break;
      case 'pow3': expr += '^3'; updateDisplay(); break;
      case 'powxy': expr += '^'; updateDisplay(); break;
      case 'pi': expr += 'π'; updateDisplay(); break;
      case 'e': expr += 'E'; updateDisplay(); break; // E -> Math.E (we have E constant)
      case 'rand': expr += Math.random().toString().slice(0,8); updateDisplay(); break;
      case 'fact': expr += '!'; updateDisplay(); break;
      case 'inv': { // reciprocal of current value
        const r = evaluateExpression(expr);
        if(r === 'Error' || r === 0){ expr = 'Error'; currEl.textContent = 'Error'; setTimeout(()=>{ expr = ''; updateDisplay(); },800); }
        else { expr = '(' + (1 / r) + ')'; updateDisplay(); }
        break;
      }
      case 'ln': expr += 'ln('; updateDisplay(); break;
      case 'log': expr += 'log('; updateDisplay(); break;
      case 'exp': expr += 'exp('; updateDisplay(); break;
      case 'equals': doEquals(); break;
      case 'mc': mem = 0; memLabel.textContent = 'M = ' + fmtValue(mem); showTempPrev('Memory cleared'); break;
      case 'mr': expr += String(mem); updateDisplay(); break;
      case 'mplus': { const r = evaluateExpression(expr); if(r !== 'Error') mem = Number(mem) + Number(r); memLabel.textContent = 'M = ' + fmtValue(mem); showTempPrev('M += ' + fmtValue(mem)); break; }
      case 'mminus': { const r = evaluateExpression(expr); if(r !== 'Error') mem = Number(mem) - Number(r); memLabel.textContent = 'M = ' + fmtValue(mem); showTempPrev('M -= ' + fmtValue(mem)); break; }
      default: break;
    }
  }

  function showTempPrev(text){
    const old = prevEl.textContent;
    prevEl.textContent = text;
    setTimeout(()=>{ prevEl.textContent = old; }, 1400);
  }

  function doEquals(){
    const raw = expr;
    const result = evaluateExpression(raw);
    if(result === 'Error'){ currEl.textContent = 'Error'; pushHistory(raw, 'Error'); expr = ''; return; }
    currEl.textContent = fmtValue(result);
    prevEl.textContent = raw;
    pushHistory(raw, result);
    expr = String(result);
  }

  // keyboard support
  window.addEventListener('keydown', (e) => {
    if(e.key >= '0' && e.key <= '9'){ expr += e.key; updateDisplay(); return; }
    if(e.key === '.') { expr += '.'; updateDisplay(); return; }
    if(e.key === 'Backspace'){ expr = expr.slice(0,-1); updateDisplay(); return; }
    if(e.key === 'Delete'){ expr = ''; updateDisplay(); return; }
    if(e.key === 'Enter' || e.key === '='){ doEquals(); return; }
    if(e.key === '+'){ expr += '+'; updateDisplay(); return; }
    if(e.key === '-') { expr += '-'; updateDisplay(); return; }
    if(e.key === '*'){ expr += '*'; updateDisplay(); return; }
    if(e.key === '/') { expr += '/'; updateDisplay(); return; }
    if(e.key === '(' || e.key === ')'){ expr += e.key; updateDisplay(); return; }
    if(e.key === '%'){ expr += '%'; updateDisplay(); return; }
    if(e.key === '^'){ expr += '^'; updateDisplay(); return; }
    // allow quick trig typing: "sin(" etc.
  });

  // deg/rad toggle
  degToggle.addEventListener('click', ()=>{
    deg = !deg;
    degToggle.textContent = deg ? 'Deg' : 'Rad';
    if(deg){ degToggle.style.background = 'var(--btn)'; degToggle.style.color = ''; }
    else { degToggle.style.background = 'linear-gradient(90deg,#333,#222)'; degToggle.style.color = '#fff'; }
  });

  // history clear
  document.getElementById('clearHist').addEventListener('click', ()=>{ hist = []; renderHistory(); });

  // init UI
  updateDisplay();
  renderHistory();
})();
</script>
</body>
</html>
